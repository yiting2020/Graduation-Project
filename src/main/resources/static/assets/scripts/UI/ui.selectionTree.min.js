(function(){var e=ui.theme.highlight.border,t=ui.theme.highlight.font,i=ui.theme.highlight.background;var n="tree-panel",r="fold-button",s="unfold-button",l="selection-item";var o=0,a="__st$parentNode";var h=3,u=14;var c="selecting",p="selected",d="canceled";var f=function(e){return this[e]};var g=function(e){var t=[],i=0;for(;i<e.length;i++){t.push(this[e[i]])}return t.join("_")};var _=function(){return this[a]};var m=ui.define("ctrls.SelectionTree",ui.ctrls.DropDownPanel,{_getOption:function(){return{multiple:false,valueField:null,textField:null,parentField:null,childField:null,data:null,canSelectNode:false,defaultOpen:false,lazy:false}},_getEvents:function(){return[c,p,d]},_create:function(){this._super();this.current=null;this.selectList=[];if(Array.isArray(this.option.valueField)){this._getValue=g}else if($.isFunction(this.option.valueField)){this._getValue=this.option.valueField}else{this._getValue=f}if(Array.isArray(this.option.textField)){this._getText=g}else if($.isFunction(this.option.textField)){this._getText=this.option.textField}else{this._getText=f}if(Array.isArray(this.option.parentField)){this._getParent=g}else if($.isFunction(this.option.parentField)){this._getParent=this.option.parentField}else{this._getParent=f}if(this.option.defaultOpen===false){this.openLevel=0}else{if(ui.core.type(this.option.defaultOpen)==="number"){this.openLevel=this.option.defaultOpen<=0?0:this.option.defaultOpen}else{this.openLevel=1e3}}if(this.option.lazy){if($.isFunction(this.option.lazy.hasChildren)){this._hasChildren=this.option.lazy.hasChildren}if($.isFunction(this.option.lazy.loadChildren)){this._loadChildren=this.option.lazy.loadChildren;this.openLevel=0}this.onTreeNodeClick=this.onTreeNodeLazyClick;this.option.lazy=true}else{this.option.lazy=false}o++;this.treeIdPrefix="st"+o+"_"},_init:function(){this.treePanel=$("<div class='tree-panel border-highlight' />");this.treePanel.click($.proxy(this.onTreeSelection,this));this.wrapElement(this.element,this.treePanel);this._selectTextClass="select-text";this._showClass="st-show";this._clearClass="st-clear";this._clear=function(){this.cancelSelection()};this.initPanelWidth(this.option.width);if(Array.isArray(this.option.data)){this._fill(this.option.data)}this._super()},_fill:function(e){this.empty();var t=$("<dl />");if(this.option.parentField&&this.option.parentField.length>0){this._listDataToTree(this.option.data,t,0)}else if(this.option.childField&&this.option.childField.length>0){this._treeDataToTree(this.option.data,t,0)}this.treePanel.append(t)},_listDataToTree:function(e,t,i){if(!Array.isArray(e)||e.length==0)return;var n={},r,s,l,o,a,h,u="children",c="fromList";for(o=0;o<e.length;o++){l=e[o];h=this._getParent.call(l,this.option.parentField)+""||"__";if(n.hasOwnProperty(h)){r=n[h];r[u].push(l)}else{r={};r[u]=[];r[u].push(l);n[h]=r}a=this._getValue.call(l,this.option.valueField)+"";if(n.hasOwnProperty(a)){r=n[a];n[a]=l;l[u]=r[u];l[c]=true}else{l[u]=[];l[c]=true;n[a]=l}}for(var p in n){r=n[p];if(!r.hasOwnProperty(c)){s=r;break}}this.option.childField=u;this.oldData=this.option.data;if(s){this.option.data=s[u];this._treeDataToTree(this.option.data,t,i)}},_treeDataToTree:function(e,t,i,n,r){if(!Array.isArray(e))return;var l,o,c;var p,d,f;var g,m,v,C=null;var y=n;for(d=0;d<e.length;d++){f=0;p=e[d];p[a]=r||null;p.getParent=_;l=y?y+"_"+d:""+d;o=this._getText.call(p,this.option.textField);if(!o)o="";m=$("<dt />");if(this.option.multiple===true){C=$("<input type='checkbox' />")}m.prop("id",this.treeIdPrefix+l);t.append(m);if(this._hasChildren(p)){c=this._getChildren(p);v=$("<dd />");if(i+1<=this.openLevel){m.append(this._createNodeButton(i,s,"fa-minus-square-o"))}else{m.append(this._createNodeButton(i,"fa-plus-square-o"));v.css("display","none")}if(this.option.canSelectNode===true&&C){m.append(C)}if(this.option.lazy){if(i+1<=this.openLevel){this._loadChildren(m,v,p)}}else{g=$("<dl />");this._treeDataToTree(c,g,i+1,l,p);v.append(g)}t.append(v)}else{f=(i+1)*(u+h)+h;if(C){C.css("margin-left",f+h+"px");f=0;m.append(C)}}m.append(this.getTreeNodeText(o,f,p,m))}},_createNodeButton:function(e){var t=$("<i class='fold-button font-highlight-hover fa' />");for(var i=1,n=arguments.length;i<n;i++){t.addClass(arguments[i])}t.css("margin-left",e*(u+h)+h+"px");return t},getTreeNodeText:function(e,t,i){var n=$("<span />").text(e).prop("title",e);if(t>0){n.css("margin-left",t)}return n},setData:function(e){if(Array.isArray(e)){this.option.data=e}else if(typeof e==="string"){this.option.data=[e]}else{return}this._fill(this.option.data)},_getChildren:function(e){return e[this.option.childField]},_hasChildren:function(e){var t=e[this.option.childField];return Array.isArray(t)&&t.length>0},_loadChildren:function(e,t,i){var n=this._getChildren(i);this.appendChildren(e,t,i,n)},appendChildren:function(e,t,i,n){var r;if(Array.isArray(n)&&n.length>0){r=$("<dl />");this._treeDataToTree(n,r,this.getLevel(i)+1,ui.str.lTrim(e.prop("id"),this.treeIdPrefix),i);t.append(r)}},getCurrentSelection:function(){var e=null;var t,i,n;if(this.current){t=this.current.prop("id");t=t.substring(this.treeIdPrefix.length);i=t.split("_");e=this.option.data[window.parseInt(i[0],10)];for(n=1;n<i.length;n++){e=this._getChildren(e)[window.parseInt(i[n],10)]}}return e},setCurrentSelection:function(e){this.cancelSelection();if(!e)return;var t=[e],i={dt:null};this._setTreeValues(this.option.data,t,0,null,i);if(i.dt){this.fire(p,i.dt,this._wrapTreeData(this.getNodeData(i.dt)))}},getMultipleSelection:function(){var e=[];for(var t=0;t<this.selectList.length;t++){e[t]=this.selectList[t].data}return e},setMultipleSelection:function(e){this.cancelSelection();if(!Array.isArray(e))return;e=e.slice(0);var t={dt:null};this._setTreeValues(this.option.data,e,0,null,t);if(t.dt){this.fire(p,t.dt,this._wrapTreeData(this.getNodeData(t.dt)))}},cancelSelection:function(e){var t=null;if(this.option.multiple===true){for(var i=0;i<this.selectList.length;i++){t=this.selectList[i].elem;t.find("input[type='checkbox']").prop("checked",false)}this.selectList=[]}else{if(this.current){this.current.removeHighlight(l,"background");this.current=null}}if(e!==false){this.fire(d)}},getNodeData:function(e){if(!e){return null}var t=e.prop("id");if(t.length==0||t.indexOf(this.treeIdPrefix)!=0){return null}t=t.substring(this.treeIdPrefix.length);return this.getDataByPath(t)},getDataByPath:function(e){if(!e){return null}var t=e.split("_");var i=this.option.data[window.parseInt(t[0],10)],n;for(n=1;n<t.length;n++){i=this._getChildren(i)[window.parseInt(t[n],10)]}return i},getLevel:function(e){var t=0;while(e[a]){t++;e=e[a]}return t},selectChildNode:function(e,t){var i=this.getNodeData(e);if(!i)return;if(this.option.canSelectNode!==true||this.option.multiple!==true){throw new Error("option properties canSelectNode and multiple must be true!")}this._selectChildNode(i,e,!!t)},selectParentNode:function(e,t){var i=this.getNodeData(e);if(!i)return;this._selectParentNode(i[a],e.prop("id"),t)},empty:function(){this.treePanel.html("");this.selectList=[];this.current=null;this.fire(d)},_setTreeValues:function(e,t,i,n,r){if(!Array.isArray(e)){return}if(!Array.isArray(t)||t.length==0){return}var s=null;var l,o,a;var h=null;for(l=0,a=e.length;l<a;l++){s=e[l];h=n?n+"_"+l:""+l;for(o=0;o<t.length;o++){if(this._equalValue(s,t[o])){r.dt=this._setTreeValue(s,h);t.splice(o,1);break}}this._setTreeValues(this._getChildren(s),t,i+1,h,r);if(t.length==0)break}},_equalValue:function(e,t){if(ui.core.type(e)==="object"&&ui.core.type(t)!=="object"){return this._getValue.call(e,this.option.valueField)===t}else{return this._getValue.call(e,this.option.valueField)===this._getValue.call(t,this.option.valueField)}},_setTreeValue:function(e,t){var i,n,r,s;var l,o,a;if(this.option.lazy){r=[];s=t.split("_");n="#"+this.treeIdPrefix+t;i=$(n);while(i.length==0){r.push(n);s.splice(s.length-1,1);if(s.length==0){break}n="#"+this.treeIdPrefix+s.join("_");i=$(n)}if(i.length==0){return}for(l=r.length-1;l>=0;l--){o=i;a=o.next();this._loadChildren(o,a,this.getNodeData(o));i=$(r[l])}}else{i=$("#"+this.treeIdPrefix+t)}a=i.parent().parent();while(a.nodeName()==="DD"){o=a.prev();if(a.css("display")==="none"){this._openChildren(o,true)}a=o.parent().parent()}this._selectItem(i,e,false,true,false);return i},_selectChildNode:function(e,t,i){var n=this._getChildren(e);if(!Array.isArray(n)||n.length==0){return}var r=t.prop("id"),s=t.next();var l=0;if(this.option.lazy&&s.children().length==0){this._loadChildren(t,s,e)}for(;l<n.length;l++){e=n[l];t=$("#"+r+"_"+l);this._selectItem(t,e,false,i,false);this._selectChildNode(e,t,i)}},_selectParentNode:function(e,t,i){if(!e){return}var n=t.substring(0,t.lastIndexOf("_"));var r=$("#"+n);var s,l,o;if(!i){s=r.next();if(s.nodeName()==="DD"){l=s.find("dt");for(o=0;o<l.length;o++){if($(l[o]).find("input[type='checkbox']").prop("checked")){return}}}}this._selectItem(r,e,false,i,false);this._selectParentNode(e[a],n,i)},_openChildren:function(e,t,i){var n=e.next();if(!i){i=e.children(".fold-button")}if(t){i.addClass(s).removeClass("fa-plus-square-o").addClass("fa-minus-square-o");n.css("display","block")}else{i.removeClass(s).removeClass("fa-minus-square-o").addClass("fa-plus-square-o");n.css("display","none")}},onTreeSelection:function(e){if(this.option.multiple){e.stopPropagation()}var t=$(e.target);var i;var s=t.nodeName();var l;if(s==="I"&&t.hasClass(r)){this.onTreeNodeClick(e);return}l=s==="INPUT";while(s!=="DT"){if(t.hasClass(n))return;t=t.parent();s=t.nodeName()}i=this.getNodeData(t);if(this.option.canSelectNode===true||!this._hasChildren(i)){this._selectItem(t,i,l)}else{if(this._hasChildren(i)){this.onTreeNodeClick({stopPropagation:ui.core.noop,target:t.children("."+r)[0]})}e.stopPropagation()}},onTreeNodeClick:function(e){e.stopPropagation();var t=$(e.target);var i=null;i=t.parent();if(t.hasClass(s)){this._openChildren(i,false,t)}else{this._openChildren(i,true,t)}},onTreeNodeLazyClick:function(e){e.stopPropagation();var t=$(e.target);var i=null,n=null;n=t.parent();i=n.next();if(t.hasClass(s)){this._openChildren(n,false,t)}else{this._openChildren(n,true,t);if(i.children().length==0){this._loadChildren(n,i,this.getNodeData(n))}}},_wrapTreeData:function(e){return{data:e,children:this._getChildren(e),parentData:e[a],isRoot:!e[a]}},_selectItem:function(e,t,i,n,r){var s=this._wrapTreeData(t);s.isNode=Array.isArray(s.children)&&s.children.length>0;var o=this.fire(c,e,s);if(o===false)return;var a=null;var h=null;if(this.option.multiple===true){a=e.find("input[type='checkbox']");if(arguments.length==3){if(i){h=a.prop("checked")}else{h=!a.prop("checked")}}else{h=n;if(a.prop("checked")==h){return}}a.prop("checked",h);s.isSelected=h;if(!h){for(var u=0;u<this.selectList.length;u++){if(this.selectList[u].elem[0]==e[0]){this.selectList.splice(u,1);break}}}else{this.selectList.push({elem:e,data:t})}}else{if(this.current){if(this.current[0]==e[0]){return}this.current.removeHighlight(l,"background")}this.current=e;s.isSelected=true;e.addHighlight(l,"background")}if(r===false){return}this.fire(p,e,s)}});$.fn.setSelectTree=function(e){if(!this||this.length==0){return null}return m(e,this)}})();(function(){var e=ui.define("ctrls.TreeView",ui.ctrls.SelectionTree,{_init:function(){this.treePanel=this.element;var e=this.treePanel.css("position");this.treePanel.addClass("tree-panel").addClass("tree-view-panel").css({position:e});this.treePanel.click($.proxy(this.onTreeSelection,this));if(Array.isArray(this.option.data)){this._fill(this.option.data)}}});$.fn.setTreeView=function(t){if(!this||this.length==0){return null}return e(t,this)}})();(function(){var e="completer-selected";var t=ui.define("ctrls.AutoCompleteTree",ui.ctrls.SelectionTree,{_create:function(){this._super();if(!$.isNumeric(this.option.limit)){this.option.limit=100}else{if(this.option.limit<=0){this.option.limit=10}else if(this.option.limit>100){this.option.limit=100}}},_init:function(){if(!this.element){return}if(this.option.multiple){throw ui.error("autoCompleterTree can not support multiple!")}this._super();var e=this;this.element.off("focus").on("focus",function(t){ui.hideAll(e);e.resetTreeList();e.show()}).on("keyup",function(t){e.onCompleterKeyup(t)});if(ui.core.ieVersion<9){this.__oldFire__=this.fire;this.fire=function(){this._callAndCancelPropertyChange(this.__oldFire__,arguments)}}this.element.textinput(function(t){var i=$(t.target),n=i.val(),r=i.data("autocomplete.value");if(e.cancelAutoComplete){return}if(n.length==0){e.resetTreeList();e.cancelSelection();return}if(e.autoCompleteListIsShow()&&r===n){return}i.data("autocomplete.value",n);if(!e.isShow()){e.show()}e.onLaunch(n)});this._clear=function(){this.cancelSelection(true,this.autoCompleteListIsShow())}},onLaunch:function(e){var t=this.option.data;if(!t||t.length==0){return}this.cancelSelection(false,false);var i=this.search(e,t,this.option.limit);this.showSearchInfo(i,e)},search:function(e,t,i){var n=[],r=[];e=e.toLowerCase();this._doSearch(n,r,e,t,i);var s=n.concat(r);return s.slice(0,i)},_doSearch:function(e,t,i,n,r,s){var l=0,o=n.length;var a,h;for(;l<o;l++){if(e.length>r){return}h=s?s+"_"+l:""+l;a=n[l];if(this._hasChildren(a)){if(this.option.canSelectNode===true){this._doQuery(e,t,i,a,h)}this._doSearch(e,t,i,this._getChildren(a),r,h)}else{this._doQuery(e,t,i,a,h)}}},_doQuery:function(e,t,i,n,r){i=i.replace('[','\\[').replace(']','\\]').replace('(','\\(').replace(')','\\)');var s=this._getText.call(n,this.option.textField).toLowerCase().search(i);if(s===0){e.push({item:n,path:r})}else if(s>0){t.push({item:n,path:r})}},showSearchInfo:function(e,t){var i=this.autoCompleteList,n;if(!i){i=this.autoCompleteList=$("<dl class='autocomplete-dl' />");i.hide();n=this;i.click(function(e){e.stopPropagation();n.onCompleterSelection(e)}).mouseover(function(e){n.onCompleterMouseover(e)});this.treePanel.append(i)}else{i.empty()}var r=0,s=[];var l,o=t;a="<span class='query-text font-highlight'>"+t+"</span>";for(;r<e.length;r++){s.push("<dt data-path='"+e[r].path+"'>");s.push("<span>");l=this._getText.call(e[r].item,this.option.textField);l=l.replace(o,a);s.push(l);s.push("</span></dt>")}$(this.treePanel.children()[0]).hide();i.append(s.join(""));i.show();this.moveSelection(1)},autoCompleteListIsShow:function(){if(this.autoCompleteList){return this.autoCompleteList.css("display")==="block"}else{return false}},resetTreeList:function(){var e=this.treePanel.children();$(e[1]).hide();$(e[0]).show()},onCompleterSelection:function(e){this.completerSelection()},onCompleterKeyup:function(e){if(e.which==ui.keyCode.DOWN){this.moveSelection(1)}else if(e.which==ui.keyCode.UP){this.moveSelection(-1)}else if(e.which==ui.keyCode.ENTER){this.completerSelection()}},onCompleterMouseover:function(t){var i=$(t.target),n;while((n=i.nodeName())!=="DT"){if(n==="DL"){return}i=i.parent()}if(this.currentCompleterElement){this.currentCompleterElement.removeClass(e)}this.currentCompleterElement=i;this.currentCompleterElement.addClass(e)},moveSelection:function(t){var i=$(this.treePanel.children()[1]).children(),n;if(!this.currentCompleterElement){this.currentCompleterElement=$(i[0])}else{this.currentCompleterElement.removeClass(e)}if(t==0){this.currentCompleterElement=$(i[0])}else if(t==1){n=this.currentCompleterElement.next();if(n.length==0){n=$(i[0])}this.currentCompleterElement=n}else if(t==-1){n=this.currentCompleterElement.prev();if(n.length==0){n=$(i[i.length-1])}this.currentCompleterElement=n}this.currentCompleterElement.addClass(e)},completerSelection:function(){var e,t,i;if(this.currentCompleterElement){e=this.currentCompleterElement.attr("data-path");t=this.getDataByPath(e);if(t){i=this._setTreeValue(t,e,1);this.fire("selected",i,this._wrapTreeData(this.getNodeData(i)))}ui.hideAll()}},_selectItem:function(){this._callAndCancelPropertyChange(this._super,arguments)},_callAndCancelPropertyChange:function(e,t){this.cancelAutoComplete=true;e.apply(this,t);this.cancelAutoComplete=false},cancelSelection:function(e,t){if(t){this._callAndCancelPropertyChange(function(){this.element.val("")});this.resetTreeList()}else{this._super(e)}}});$.fn.setAutoSelectTree=function(e){if(!this||this.length==0){return null}return t(e,this)}})();